## Change Log

`19.12.2020` - Крупное обновление. Много кода переписано, с учётом добавления собранных и собираемых теперь `/worldtop`.
Привёл битвы к расчету по GMT+0 (раньше считал по GMT+3), стало сильно удобнее. В команду `/worldtop` добавил отображение 
тех самых добавочных кубков, которые замки получают за выполнение квестов (не на битве). Команды `/average`, `/season`, `/place` теперь
учитывают добавочные кубки. Добавил нормальную работу в чатах.

`14.12.2020` - Добавленные `/worldtop` из ChatWars стал записывать по GMT+3, хотя Telegram возвращает свои stamp по GMT+0,
надо будет перейти всюду на GMT+0, а выводить уже по GMT+3.

`11.12.2020` - После последнего обновления (с началом сезона `01.12.2020`) в ChatWars 3 добавились новые пути получения кубков для замков.
Получается, что подсчёт сводок по порядку оказывается бессмысленным. Но я решил его модернизировать, не удалять же код ей-богу.
Добавил в бота возможность вручную вносить `/worldtop` из ChatWars. Ну и заодно автоматизировал аккаунт, чтобы он присылал `/worldtop`
в бота перед битвой, потому что других вариантов я не вижу.

`10.12.2020` - Оказалось, что я забыл задать начальную сортировку битв. Это не сильно сказывалось на процессе подсчетов,
потому что битвы и так последовательно вносятся в таблицу, но если в будущем, какая-нибудь битва попадет не туда, начнутся проблемы.
Превентивно добавил сортировку всех битв по времени.

`22.11.2020` - Добавил дополнительную сортировку в `/average`, обычная сортировка по кубкам не подходит. 
Сортируем по полученным значениям.

`21.11.2020` - Неплохо так переписал код, особенно в той части, где было взаимодействие с пользователем. Теперь любая команда работает
в двух режимах, если отправлена просто команда, оно считает от начала конкретного сезона до последней битвы по умолчанию.
Если после команды дописаны две даты, оно будет считать в заданном диапазоне. Также неплохо сделал очистку от нежелательных
элементов в сообщении от пользователя. Переработал заголовки каждой команды, вынес это в отдельную text_header() функцию.

`20.11.2020` - Фикс бага в world_top_sorted(). Оказалось я изначально не сортировал битвы по порядку и никогда статистика не была
верной. Сейчас пофикшено наполовину, надо **обязательно** сначала сортировать битвы по времени, а потом уже проводить манипуляции.

`18.11.2020` - Новая команда `/worldtop`, переписал наконец скрипт world_top (теперь это true_world_top()), фикс мелких багов.

Добавил новую команду `/average` - она вытекает из уже представленной ранее `/season`. Суммирует положения замка и делит на количество битв
получается число, которое отражает среднее место в сезоне у замка.

## Летопись
### ChatWars 3 сводки битв за неделю, месяц, год и не только.
`29 декабря 2018 года` Как сейчас помню. Стрельнула тогда мне в голову мысль написать бота, который бы подвел итоги 
первого года игры (с мая по декабрь) и вывел бы красивые сводки, очень похожие на мини-сводки, только не за одну битву,
а за все битвы в том году, а еще сгенерировать за каждую прошедшую неделю и месяц сводку.

> И я довольно быстро справился, правда уже было `31 декабря`, я писал тогда ужасно костыльный код, но тогда это сработало.

Сводки было решено публиковать на канале [CWWeekDigest](https://t.me/CWWeekDigest). Но это не очень весело. 
Поэтому в тот день я сгенерировал и отправил на этот канал сводки за год, как и планировал изначально.

Собственно вот этот самый пост [CWWeekDigest/83](https://t.me/CWWeekDigest/83). 
Он произвел большое впечатление в комьюнити и его репостнули себе все крупные каналы по этой игре.

`Дальше все было спокойнее` Бот работал еще полгода, канал собрал небольшую аудиторию, все было ничего, работало.
Но в какой-то момент что-то изменилось, возможно я напортачил с алгоритмом, что скорее всего. И бот сломался.

Мне было лень его чинить, потому что его лучше было переписать заново. Я забил на это дело и просто отключил его.

> Хотя, судя по коммитам на гитхабе, я пытался воскресить его в `сентябре 2019 года`, но видимо безуспешно.

`30-31 декабря 2019 года` Я мощно вспоминаю про то, что я единственный кто был заинтересован в создании сводок за год.
Тогда я переписал большую часть бота, добавились зачатки моей библиотеки, тогда я еще не думал, что когда-нибудь будет
что-то подобное, поэтому просто копировал из проекта в проект удобные полезные функции.

По итогу, после последней битвы в том году я публикую сводки за `2019 год` [CWWeekDigest/176](https://t.me/CWWeekDigest/176).
Но после этого бот выключен и не делает сводок за недели и месяцы, я тогда не успел допилить этот функционал. После нового года
я попытался, но безуспешно видимо.

Вообще, я переквалифицировал этого бота в просто записывающего битвы в базу и не делающего больше ничего.

В начале `января 2020 года` ко мне постучался один важный человек в этой игре и предложил реализовать один потенциал:
> Подсчитывать на каждый сезон (за любой выбранный промежуток времени) положения и ротацию замков и их очков в игре.

Я реализовал этот функционал за пару дней и отправился обновлять других своих ботов. Не следил, пользовался им кто-нибудь.
Скорее всего не пользовался, потому что я вспомнил о существовании этого бота, только когда решил систематизировать свои 
репозитории на гитхабе.

`Ноябрь 2020 года` Постарался переписать весь код, который тут был, уже с добавлением своей библиотеки e-objects. Спарсил заново
старые битвы, правильно настроил парсинг новых битв, их хранение и проверку, теперь я могу быть уверен, что ни одна битва не потеряется. 
В процессе поиска ошибок, нашли битву, которой не было нигде, даже на канале. Пришлось вносить ее вручную (ну точнее
ту информацию, которую можно косвенно собрать, а это только `/worldtop` из игры).

Также, сделал динамически изменяющуюся команду `/season`, где можно подсчитать положения замков сразу в текущем сезоне, без
ввода даты, очень удобно я считаю. Когда проходит битва, описание у команды меняется для любого кто вызовет контекстное меню `/` в боте. 
Запарился конечно на 10+.

Добавил функцию `/worldtop`. Прямо с таким же дизайном как в игре, чтобы можно было сверять вдруг чего-то не хватает или не совпадает.

Единственное, что я кардинально не переписывал это функцию summary, которая сводки генерирует. Я пока не планирую возвращать сводки
за недели и месяцы, а я еще сейчас подумал и стоило бы сводки публиковать за сезоны.

#### Что дальше?

Думаю, что ближе к новому году и традиционным годичным сводкам я перепишу эту функцию и может быть все же сделаю обещанные сводки
за недели, месяцы и сезоны. Пока оставляю как есть, в декабре посмотрим что к чему, обязательно.

---

Ниже привожу ссылку на таблицу (ссылка закрытая, оставил для себя).
> `Краткое описание` Таблица состоит из одного листа с названием main, на этом листе всего один столбец и 15к строк.
> На данный момент 2700 строк заполнено битвами, остальные свободны.

Название | Описание
-------- | --------
[Digest](https://docs.google.com/spreadsheets/d/16yXVEAfmVmSMDp07kpgMpG22smbDmf8sZgQSFKWpU7g/edit?usp=sharing) | База битв игры ChatWars 3